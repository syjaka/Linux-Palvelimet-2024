# Keskeneräinen

# Labraharjoitus vuodelta 2021 
Tehtävän suoritus alkoi 06.03 klo 12.07 ja keskeytin 12.58
- Jatkoin 16.30 ja keskeytin 1.30
- seuraavana päivänä aloitin klo 12.30

Tässä tehtävässä suoritettavat toimet ovat:

1. [Oma Käyttäjä]()
2. [Turvallisesti etänä]()
3. [Luo uusi komento]()
4. [kippo.examole.com]()
5. [sanko.example.com]()
6. [ampari.example.com]()
7. [Kurlataan]()
8. [Tietokanta]()
9. [Analysisi]()
10. [Lisää kippoja]()
11. [Alkutoimet]()
  
## 11. Alkutoimet

Ylimääräisten lisäosien/määritysten asennus
  - `export EDITOR=micro` micr
  - `sudo apt-get install pwgen`
  - `sudo apt install xpad`
  - `micro --plugin install misspell`
  - `sudo apt-get -y install`  git` , `cd $HOME/.config/micro/plug/` ja `git clone https://github.com/terokarvinen/micro-run.git`

## 1. Oma käyttäjä
  - Tee järjestelmään oma käyttäjä jolla tiedoissa minun nimi ja anna käyttäjälle sudo-oikeudet
>   - `sudo adduser kadriye`ja `sudo adduser kadriye sudo` `su kadriye`
  - Tallenna käyttäjän kotihakemistoon dokumentti lab.txt. Lisää tiedoston alkuun oma nimi ja linkki kotitehtäväpakettiin
>   - Siirryn kotihakemistoon rootin kautta. hakemistossa `/home/kadriye` luon `micro lab.txt` ja lisäsin pyydetyt.
  - Tallenna tiedostoo kaikista palveluista (ja muista käyttäjälle tehdyistä asioista) ja testit, joilla olet tarkistanut niiden toimivuuden. Laita tiedostoon myös kaikki salasanat.
  - Suojaa tiedosto chmodilla niin että ulkopuoliset eivät nää sitä (tässä kysymys, ovatko muut käyttäjät ulkopuolisia? tulkitsen että vain others ovat ja muut käyttäjät saavat nähdä).
>   - `sudo chmod u=rwx,g=r,o= /home/kadriye/lab.txt` suojaa tiedoston siten että käyttäjällä kaikki, käyttäjän ryhmällä luku ja ulkopuolisilla ei mitään.
  - Tiedoston nimen tulee olla oikein, eli se tulee löytyä 'ls /home/*/lab.txt'.
>    - Tarkistettu toimivaksi
>    - Tässä vaiheessa tein pikku glitsin sulkemalla tauon ajaksi koneen. `kadriyen`kirjautumissalasana oli tallennettu tiedostoon ja suojattu. Onneksi `sudo`ryhmällä on oikeudet jollon `kadi`pääsi `kadi@KippoOy:/home$ sudoedit /home/kadriye/lab.txt`tarkistamaan salasanan

---

## 2. Turvallisesti etänä
  - Aiot kuulemma siirtyä etätöihin Hawajille. Valmistaudu ylläpitämään konetta ssh:lla. (Testaa paikallisesti, että SSH toimii).
>   - `sudo apt update` ja `sudo apt upgrade -y` päivittää ajan tasalle
>   -  `sudo apt install openssh-server -y` asentaa OpenSSH-palvelimen ja `sudo systemctl status ssh` tarkistaa palvelimen tilan
>   -  Tässä vaoiheessa huomasin että palomuuri oli jo asennettu ja päällä alkutoimien johdosta. Tarkistin sen tilan `sudo systemctl status ufw`
>  -  `sudo ufw allow ssh` `sudo ufw enable` Sallii SSH-palomuurissa `sudo ufw status` tarkistaa tilan ja `sudo systemctl ufw` potkasee muutokset voimaan.
>  -  `ssh kadi@localhost`testaa
>  -  ![7.1_2021_1_ssh_vastaa](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_1_ssh_vastaa.png)
  - Luo käyttäjät ja listaa käyttäjätunnukset ja salasanat aiemmin tekemääsi lab.txt tiedostoon.:
>   - Ossi Otsomaja on     `Ossi Otsomaja           ossiot          xi7NBsCXK3a09EkY2eGP`
>   - Arnold Sjöbrengrörez `Arnold Sjöbrengrörez    arnosj          Iawrcv89OI945cyj4WjX`
>   - Einari Vähäkäähkö    `Einari Vähäkäähkö       einava          KnK4Q21gWKU4dBYJ0xWZ`
>   - Erkki Esimerkki      `Erkki Esimerkki         erkkes          f3hQAopcuTnfU1Ia0iA6`
>   - Maija Mallihenkilö   `Maija Mallihenkilö      maijma          EnaVVgK2laVv8QML32sF`
>   - Kadriye Syrjä        `Kadriye Syrjä           kadriye         JBClkPq8NPJbFU6OW6SO`

## 3. Luo uusi komento
 - Tee meille uusi komento 'netsee', joka kertoo verkon tilasta. Haluamme nähdä ainakin reititystaulun ja oman IP-osoitteen. Voit lisätä halutessasi jonkin ekstratiedon. Komennon tulee toimia kaikilla käyttäjillä.
> - Siirryn ja luon kadriyen kotihakemistoon `mkdir -p skriptit/netsee` komennon ja teen bash-skriptin
> - ![7.1_2021_1_netsee_micro](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_1_netsee_micro.png)
> - `bash netsee` palauttaa
> - ![7.1_2021_2_bash_netsee](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_2_bash_netsee.png)
> - `chmod ugo+rx netsee` annan oikeudet kaikille suorittaa komento
> - Kirjaudun Arnoldina sisään ja testaan
> - ![7.1_2021_3_arnoldi_testaa](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_3_arnoldi_testaa.png)


## 4. kippo.example.com
 - Tee meille weppipalvelu osoitteeseen kippo.example.com. Voit simuloida nimipalvelun toimintaa hosts-tiedoston avulla.
   > - `sudo apt-get -y install apache2` asensi apachen
   > - `echo "defaulttii" |sudo tee /var/www/html/index.html` korvaa defaultin
   > - `sudoedit /etc/apache2/sites-available/kippo.example.com.conf`luo conffin
   > - `sudo a2ensite kippo.example.com.conf` enabloi luodun conffin ja `sudo a2dissite 000-default.conf` poistaa defaultin saatavilta
   > - `sudo systemctl restart apache2` polkasee muutokset vauhtiin
   > - `su ossiot` muuttaa käyttäjäksi Ossin ja `mkdir -p /home/ossiot/publicsites/kippo.example.com/`luo hakemiston html sivulle
   > - `echo kippo > /home/ossiot/publicsites/kippo.example.com/index.html`luo html tiedoston ja tallentaa sinne kippo. Samalla huomasin että conf tiedostossa on väärä polku.
   > - Kävin korjaamassa polkuun kadriyen tilalle `ossiot`
   > - `curl -H 'Host: kippo.example.com' localhost`ja `curl localhost` testaa
   > - tulee `<title>403 Forbidden</title>`tarkistan lokit ja errorlog paljastaa että conf tiedostoon on jäänyt kadriye `AH00035: access to / denied (filesystem path '/home/kadriye/publicsites') AH00035: access to / denied (filesystem path '/home/kadriye/publicsites') `
   > - tarkistin confin, mutta en tajunnut ottaa niitä käyttöön eli apache potkastaa
   > - Vielä sama virhe mutta polku vaihtunut ossiin. Palasin tarkistamaan polun ja selvisi, että index.html ei ollut paikallaan
   > ![7.1_2021_5_erroria](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_5_erroria.png)
   > - Tein sen `micro index.html`ja loin sinne validin html5 sisällön.
   > - Sama error jatkuu samalla vikakoodilla. Palomuurissa ei taida olla aukkoa portille 80. Tein sen `sudo ufw allow 80/tcp`mutta sama vikakoodi.
   > - Ongelma on pakko olla oikeuksissa `chmod ugo+rx /home/ossiot` ja `sudo chmod -R ugo+rx /home/ossiot`ja muutama muu tuskissaan tehty komento ratkaisi. Epäilen että se on toinen noista. Testi kuitenkin paljasti että weppipalvelu vastaa
   > ![7.1_2021_6_kippo vastaa](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_6_kippo%20vastaa.png)

 - Tee sivu siten, että webmasterimme Ossi pääsee muokkaamaan sivuja. Tee Ossille valmiiksi validi HTML5-sivu pohjaksi. Siis siten, että osoitteesta kippo.example.com näkyy validi esimerkkisivu, josta selkeästi näkyy, että on tultu Kipppo-sivulle.
    > - Muokkaan vielä HTMLää tehtävän mukaiseksi ja testaan selaimella
    > ![7.1_2021_7_tulikettu_kippo_vastaa](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_7_tulikettu_kippo_vastaa.png)
    > ![7.1_2021_7_tulikettu_kippo_vastaa_www](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_7_tulikettu_kippo_vastaa_www.png)
   

## 5. sanko.example.com
  - Tee meille toinen weppipalvelu samalle koneelle osoitteeseen sanko.example.com samaan tapaan kuin edellinen. Tätä sivua pitäsi päästä muokkaamaan Sanko-tiimimme Einari ja Erkki, joskin tiimin jäsenet voivat tulevaisuudessa vaihtua. Tee myös Sanko-tiimille validi esimerkkisivu.
     > - Teen aluksi ryhmän sanko johon einari ja erkki kuuluvat `sudo groupadd sanko` ja `sudo usermod -a -G sanko erkkes` ja `sudo usermod -a -G sanko einava` (linux.fi/a 2019)
     > - Luon sudona kotihakemistoon /home/weppi/haksanko ja annan sanko ryhmälle oikeudet haksankoon
     > - `sudo chgrp sanko /home/weppi` muuttaa weppi hakemiston sankon omistukseen (linux.fi/c, 2023)
     > - `sudo chmod u+rwx,g+rx,o-x /home/weppi` muokkasi sankolaisille ajo-oikeudet ja muille ei mitään (linux.fi/b, 2011)
     > - Lopputuloksena oikeudet kuten kuvassa, (kuvasta jäi ossiot pois jolla weppi kansioon yrittäessä tulee `Permission denied`: `journactl`ei ole kirjannut mitään
     >  ![7.1_2021_8_weppi_ei_laske](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_8_weppi_ei_laske.png)
     > - Koska myös sudouserin ja mahdollisten tulevaisuuden weppikehittäjäryhmien pitää päästä weppihakemistoon vaihdoin taktiikkaa ja teen korkeamman ryhmähierarkian
     > - weppiset - ryhmään kuuluu kaikki weppikehitykseen osallistuvat ja sudouser. Sanko ryhmään kuuluvat sanko projektiin kuuluvat ja sudouser
     >   ![7.1_2021_9_ryhmat](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_9_ryhmat.png)
     > - Tämä ratkaisi asian ainakin pääsyn kannalta, mutta esim kansion listaus ei onnistu. `journactl`ei ole kirjannut mitään
     >  ![7.1_2021_10_weppii_sallii](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_10_weppii_sallii.png)
     > - Tässä vaiheessa nostin kädet ylös ja otin sallitun ulkopuolelta GhatGPT:n apuun. Sieltä tuli aika simppeli ratkaisu. Oikeudet vaatii uloskirjautumisen tullakseen voimaan ... Plääh, siinä pari ylimääräistä tuntia, mutta toisaalta oikeuksien kielioppi on nyt kaikin päin hallussa :)
     > - Ei auttanut kokeilin vielä omistajuuden muutosta sudona ja roottina, mikään ei muuta. Luovutan, jatkan ja kysyn tunnilla. `journactl`ei ole kirjannut mitään
     > - Koska periaate on "principle of least privilege" jatkan einavan kanssa joka luo `mkdir sanko.example.com` sanko hakemistoon ja sinne index.html
     > - conf tiedostot vaativat sudo-oikeudet joten luon sen ja asetan sanko palvelimen aktiiviseksi kadriye-käyttäjänä.
     > - `curl -H 'Host: sanko.example.com' localhost` vastaa errorilla oikeuksista. Sama kuin yllä.
     > - `-rw-r--r-- 1 einava einava 488  6. 3. 22:55 index.html`löytyy vastaus. siirrän omistajuuden ja päivitän oikeudet
     > - einava käyttäjä hakemistossa /home/weppi/haksanko/sanko.example.com komennolla `chgrp sanko index.html` muuttaa ryhmän `sanko`ksi
     > - sitten koko kansiopolun oikeuksien tarkistaminen `ls -l`komennoilla. Joka askeleella ryhmälle tuli lisätä `chmod g+w`oikeudet Lisäksi sudokäyttäjän lisäys `chmod o+x /home/weppi/haksanko/`haksanko-hakemistoon
     > - testaan kurlata ja edelleen sama virhe. loki tarrjoaa virhettä `sanko.example.com:80 127.0.0.1 - - [06/Mar/2024:23:54:36 +0200] "GET / HTTP/1.1" 403 443 "-" "curl/7.88.1"`
     > - En keksinyt enää muuta syytä kuin weppi-hakemiston sijainti. Päätin kokeilla einavin kotihakemistoon
     > - `mv /home/weppi/haksanko/publicsites/ /home/einava/`siirsi paketin kaikkine hyvineen einavan kotihakemistoon
     > - conf-tiedoston polun päivitys ja oikeuksien tarkistus. Mutta ei vieläkään ratkaisua. Kippo toimii sanko ei. Alla oikeuksien vertailu
     > - ![7.1_2021_11_en_enaa_jaksa](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_11_en_enaa_jaksa.png) ![7.1_2021_12_en_enaa_jaksa_en](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_12_en_enaa_jaksa_en.png)
     > - Ja kun olin hakemassa viimeistä lokia, siellä oli muuttunut virhe.
     > - ![7.1_2021_13_loki kertoo](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_13_loki%20kertoo.png)
     > - Tämä antoi syytä vertailla eri käyttäjien kotihakemistojen oikeuksia.
     > - ![7.1_2021_14_userdi_rights](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_14_userdi_rights.png)
     > - `sudo chmod u=rwx,g=rx,o=rx /home/einava`päivtti ne ja siinä se oli. Homma toimii klo 1.09
     > - ![7.1_2001_15_ei_voi_olla](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2001_15_ei_voi_olla.png)
     > - Päivitin tähän vielä validin verkkosivun
     > - ![7.1_2021_16_tulikettu_sanko_vastaa_www](https://github.com/syjaka/Linux-Palvelimet-2024/blob/main/images/7.1_2021_16_tulikettu_sanko_vastaa_www.png)

    
## 6. ampari.example.com
  - Ampari on uusi palvelumme, josta käyttäjä saa kiintoisia tietoja. Palvelua voi käyttää millä vain käyttöjärjestelmällä ja selaimella.
  - Tee meille tuotantotyyppinen asennus weppipalvelusta Flaskilla.
    > Ohjeista poiketen tein asennuksen Djangolla, aloitin staattisen hakemiston luonnilla ja testillä.
    

    > - `sudo apt-get -y install virtualenv` asensi virtuaalisen ympäristön.
    > - `virtualenv -p python3 --system-site-packages env` loi virt ympäristön ja `source env/bin/activate` aktivoi sen ja varmistin `which pip`.
    > - Loin Django asennustiedoston `micro requirements.txt`ja kirjoitin sinne django
    > - `pip install -r requirements.txt`asensi Djangon 5.0.3 version.
    > - `django-admin startproject ampari`aloitti **ampari**-projektin ja loi publicwsgi-hekemistoon ampari hakemiston.
    > - 
    > - `sudo apt-get -y install libapache2-mod-wsgi-py3` asensi WSGI-moduulin
    > - ` /sbin/apache2ctl configtest` Palautti Syntax OK
    > - Apachen polkasun jälkeen `curl -sI localhost|grep Server` kertoi Apachen olevan palvelin ja localhost selaimella näytti Djangon olevan päällä.
    > - `micro requirements.txt`tiedostoon tallensin django, joka sitten asentui `pip install -r requirements.txt`
    > - `django-admin startproject ampari` aloitti ampari projektin. Siirryin /ampari hakemistoon kotihakemistossani, ja käynnistin testiympäristön `./manage.py runserver`
    > - selaimella navigoidessa 127.0.0.1:8000/ avautuu oletussivu eli asennus onnistui. `ctrl + C`sulkee testiympäristön
    > - `./manage.py makemigrations`ja `./manage.py migrate` päivitti tietokannan. Testasin ja toimii yhä.

  - Tee Python Flaskilla palvelu, josta löytyy seuraavat osoitteet:
    - http://ampari.example.com/ "Hei amparien maailma" (literaalisti tämä teksti)
    - http://ampari.example.com/today Päivämäärä ja kellonaika
    > -

## 7. Kurlataan
   - Nörttimme kaipaavat teknistä tietoa weppipalveluista. Kerää raporttisi perään 'curl -i http://localhost' tiedot jokaisesta URLsta, jotka olet tehnyt vastauksena tämän tehtävän eri kohtiin.
     
## 8. Tietokanta
   Kaipaatko haastetta, havitteletko huipputuloksia? Tässä vähän haastavampaa pidemmälle ehtineille.
    - Dynaamisuus on päivän sana. Tee meille Flask-ohjelma, joka lukee tietokannasta astioita ja hintoja.
    - Käytä tuotantoon sopivaa tietokantaa, esim PostgreSQL tai MariaDB.
    - Laita astioihin ainakin 'Kippo' 200 (euroa); "Kuppi", 10; "Leili", 50.
      - http://ampari.example.com/astioita/

## 9. Analysis!
  Tässä sovellettavaa propellihatuille:
    - Analysoi weppipalvelimen lokeja GoAccess-ohjelmalla.
    - Listaa poimintoja tuloksista ja selitä ne (lab.txt:ssä).

## 10. Lisää kippoja
  Tämä on bonuksen bonus tehtävä, josta ei ole opettettu kurssilla.
    - Tee tietokantasi weppiliittymä, josta voi lisätä kippoja ja kuppoja.
    - http://ampari.example.com/astioita/admin/

     

Lähteet:

linux.fi/a, Käyttäjien hallinta 2019. Luettavissa https://www.linux.fi/wiki/K%C3%A4ytt%C3%A4jien_hallinta. Luettu 06.03.2024

linux.fi/b, Kansion yhteiskäyttö ryhmissä 2011. Luettavissa: https://www.linux.fi/wiki/Kansion_yhteisk%C3%A4ytt%C3%B6_ryhm%C3%A4ss%C3%A4. Luettu 06.03.2024

linux.fi, chgrp 2023. Luettavissa: https://www.linux.fi/wiki/Chgrp. Luettu 06.03.2024

